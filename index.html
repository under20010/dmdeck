<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>観戦メモ（卓ごと最小構成）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f3f4f6;
      font-size:14px;
    }
    header{
      background:#111827;
      color:#fff;
      padding:12px 16px;
      text-align:center;
    }
    header h1{ margin:0; font-size:18px; line-height:1.3; }
    main{
      max-width:900px;
      margin:0 auto;
      padding:12px;
    }
    .section{
      background:#fff;
      border-radius:10px;
      padding:12px;
      margin-bottom:12px;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
      border:1px solid #e5e7eb;
    }
    .section h2{
      margin:0 0 8px 0;
      font-size:15px;
    }
    label{ display:block; margin-bottom:6px; }
    input[type="number"],
    input[type="text"],
    textarea{
      width:100%;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #d1d5db;
      font-size:13px;
      box-sizing:border-box;
    }
    textarea{
      resize:vertical;
      min-height:40px;
    }

    .table-row{
      border-top:1px solid #e5e7eb;
      padding:8px 0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .table-title{
      font-weight:600;
      font-size:13px;
    }

    .small-label{
      font-size:11px;
      color:#6b7280;
    }

    button{
      border:none;
      border-radius:999px;
      padding:6px 12px;
      font-size:13px;
      cursor:pointer;
      background:#e5e7eb;
      color:#111827;
      margin-right:6px;
      margin-bottom:6px;
    }
    button.danger{
      background:#b91c1c;
      color:#fff;
    }
    button.warning{
      background:#f97316;
      color:#fff;
    }
    button.primary{
      background:#2563eb;
      color:#fff;
    }

    @media (min-width:640px){
      .table-row{
        flex-direction:row;
        align-items:flex-start;
      }
      .table-col{
        flex:1;
        min-width:0;
      }
      .table-col.memo{
        flex:1.4;
      }
    }
  </style>
</head>

<body>
<header>
  <h1>観戦メモ（卓ごと）</h1>
</header>

<main>
  <section class="section">
    <h2>ラウンドと卓数</h2>
    <label>
      ラウンド番号：
      <input type="number" id="roundInput" min="1" value="1">
    </label>

    <label>
      最大卓番号：
      <input type="number" id="maxTableInput" min="1" max="64" value="8">
    </label>

    <p class="small-label">
      入力内容はラウンドごとに自動保存されます（同じ端末・同じブラウザで有効）。
    </p>
  </section>

  <section class="section">
    <h2>卓ごとのメモ</h2>
    <div id="tableList"></div>
  </section>

  <section class="section">
    <h2>操作</h2>
    <button id="resetRoundBtn" class="warning">このラウンドをリセット</button>
    <button id="resetAllBtn" class="danger">全ラウンドをリセット</button>
    <button id="copyRoundBtn" class="primary">このラウンド内容をコピー</button>
    <p class="small-label">
      コピーしたテキストをLINEやDiscordに貼れば、他の人も内容を確認できます。
    </p>
  </section>
</main>

<script>
  const STORAGE_KEY = "watch_notes_by_table_simple_v2";

  function loadData(){
    try{
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    }catch(e){
      return {};
    }
  }
  function saveData(data){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  let data = loadData();

  const roundInput = document.getElementById("roundInput");
  const maxTableInput = document.getElementById("maxTableInput");
  const tableList = document.getElementById("tableList");
  const resetRoundBtn = document.getElementById("resetRoundBtn");
  const resetAllBtn = document.getElementById("resetAllBtn");
  const copyRoundBtn = document.getElementById("copyRoundBtn");

  function currentRound(){
    const r = Number(roundInput.value || "1");
    return r > 0 ? r : 1;
  }

  function getRoundData(round){
    if(!data[round]) data[round] = {};
    return data[round];
  }

  function saveRow(round, tableNo){
    const row = document.querySelector('.table-row[data-table="' + tableNo + '"]');
    if(!row) return;

    const deck = row.querySelector(".deck-input").value.trim();
    const memo = row.querySelector(".memo-input").value.trim();

    const roundData = getRoundData(round);

    if(!deck && !memo){
      delete roundData[tableNo];
    }else{
      roundData[tableNo] = {
        deck,
        memo,
        updatedAt: Date.now()
      };
    }
    saveData(data);
  }

  function renderTables(){
    const round = currentRound();
    const maxTable = Math.min(Math.max(Number(maxTableInput.value || "1"),1),64);
    maxTableInput.value = maxTable;

    const roundData = getRoundData(round);

    tableList.innerHTML = "";

    for(let t=1; t<=maxTable; t++){
      const info = roundData[t] || { deck:"", memo:"" };

      const row = document.createElement("div");
      row.className = "table-row";
      row.dataset.table = t;

      const colInfo = document.createElement("div");
      colInfo.className = "table-col info";

      const title = document.createElement("div");
      title.className = "table-title";
      title.textContent = "卓" + t;
      colInfo.appendChild(title);

      const deckLabel = document.createElement("div");
      deckLabel.className = "small-label";
      deckLabel.textContent = "デッキ名";
      colInfo.appendChild(deckLabel);

      const deckInput = document.createElement("input");
      deckInput.type = "text";
      deckInput.placeholder = "例：アナカラーハンデス / 5c など";
      deckInput.value = info.deck || "";
      deckInput.className = "deck-input";
      colInfo.appendChild(deckInput);

      const colMemo = document.createElement("div");
      colMemo.className = "table-col memo";

      const memoLabel = document.createElement("div");
      memoLabel.className = "small-label";
      memoLabel.textContent = "メモ（カード名、動き、対戦相手情報など）";
      colMemo.appendChild(memoLabel);

      const memoInput = document.createElement("textarea");
      memoInput.className = "memo-input";
      memoInput.placeholder = "例：3本目にジョギラゴン、対戦ID #1234 など";
      memoInput.value = info.memo || "";
      colMemo.appendChild(memoInput);

      row.appendChild(colInfo);
      row.appendChild(colMemo);
      tableList.appendChild(row);

      deckInput.addEventListener("input", function(){ saveRow(round, t); });
      memoInput.addEventListener("input", function(){ saveRow(round, t); });
    }
  }

  roundInput.addEventListener("change", function(){
    renderTables();
  });
  maxTableInput.addEventListener("change", function(){
    renderTables();
  });

  resetRoundBtn.addEventListener("click", function(){
    const round = currentRound();
    if(!confirm("ラウンド" + round + "の内容を全て消しますか？")){
      return;
    }
    delete data[round];
    saveData(data);
    renderTables();
  });

  resetAllBtn.addEventListener("click", function(){
    if(!confirm("全てのラウンドのデータを消しますか？")){
      return;
    }
    data = {};
    saveData(data);
    renderTables();
  });

  copyRoundBtn.addEventListener("click", function(){
    const round = currentRound();
    const roundData = getRoundData(round);
    const tables = Object.keys(roundData).map(function(k){ return Number(k); }).sort(function(a,b){ return a-b; });

    let text = "ラウンド" + round + " 観戦メモ\n";
    if(tables.length === 0){
      text += "（メモはありません）\n";
    }else{
      tables.forEach(function(t){
        const info = roundData[t];
        const deck = info.deck || "";
        const memo = info.memo || "";
        text += "卓" + t + " デッキ:" + deck + " メモ:" + memo + "\n";
      });
    }

    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(function(){
        alert("このラウンドの内容をクリップボードにコピーしました。");
      }).catch(function(){
        alert(text);
      });
    }else{
      alert(text);
    }
  });

  renderTables();
</script>
</body>
</html>
